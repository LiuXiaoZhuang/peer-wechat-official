"use strict";var t=require("axios"),e=require("crypto"),i=require("xml2js");function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function a(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var r=s(t),n=a(e),c=a(i);class p{constructor(){this.logger=console}setLogger(t){this.logger=t}setAccessToken(t){this.accessToken=t}async request(t,e={}){try{let i=await r.default(t,e);return i.status<200||i.status>=204?(null!==this.logger&&this.logger.error("[WechatOfficial]网络错误："+JSON.stringify({url:t,options:e})),{status:"network",result:null,error:null}):"errcode"in i.data&&0!==i.data.errcode?(null!==this.logger&&this.logger.warn("[WechatOfficial]结果失败："+JSON.stringify({url:t,options:e})),{status:"fail",result:null,error:i.data}):(this.logger.info("[WechatOfficial]请求成功："+JSON.stringify({url:t,options:e,res:i.data})),{status:"success",result:i.data,error:null})}catch(i){null!==this.logger&&this.logger.error("请求错误："+JSON.stringify({url:t,options:e}))}return{status:"system",result:null,error:null}}}class u{constructor(t,e,i){this.appID=t,this.appSecret=e,this.util=i}async getAccessToken(){return this.util.request("https://api.weixin.qq.com/cgi-bin/token",{method:"GET",params:{grant_type:"client_credential",appid:this.appID,secret:this.appSecret}})}async getApiDomainIP(){return this.util.request("https://api.weixin.qq.com/cgi-bin/get_api_domain_ip",{method:"GET",params:{access_token:await this.util.accessToken(this.appID)}})}}class o{constructor(t,e,i){this.appID=t,this.appSecret=e,this.util=i}async clearQuota(){return this.util.request("https://api.weixin.qq.com/cgi-bin/clear_quota",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{appid:this.appID}})}async getQuota(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/openapi/quota/get",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{cgi_path:t}})}async getRid(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/openapi/rid/get",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{rid:t}})}}class l{constructor(t,e,i){this.appID=t,this.appSecret=e,this.util=i}async create(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/menu/create",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:t})}async getCurrentSelfmenuInfo(){return this.util.request("https://api.weixin.qq.com/cgi-bin/get_current_selfmenu_info",{method:"GET",params:{access_token:await this.util.accessToken(this.appID)}})}async delete(){return this.util.request("https://api.weixin.qq.com/cgi-bin/menu/delete",{method:"GET",params:{access_token:await this.util.accessToken(this.appID)}})}async addConditional(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/menu/addconditional",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:t})}async delConditional(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/menu/delconditional",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{menuid:t}})}async trymatchConditional(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/menu/trymatch",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{user_id:t}})}async getMenu(){return this.util.request("https://api.weixin.qq.com/cgi-bin/menu/get",{method:"GET",params:{access_token:await this.util.accessToken(this.appID)}})}}class h{constructor(t,e,i){if(!t||!e||!i)throw new Error("please check arguments");this.token=t,this.id=i;let s=Buffer.from(e+"=","base64");if(32!==s.length)throw new Error("encodingAESKey invalid");this.key=s,this.iv=s.slice(0,16)}getSignature(t,e,i){let s=n.createHash("sha1"),a=[this.token,t,e,i].sort();return s.update(a.join("")),s.digest("hex")}decrypt(t){let e=n.createDecipheriv("aes-256-cbc",this.key,this.iv);e.setAutoPadding(!1);let i=Buffer.concat([e.update(t,"base64"),e.final()]);i=function(t){let e=t[t.length-1];return(e<1||e>32)&&(e=0),t.slice(0,t.length-e)}(i);let s=i.slice(16),a=s.slice(0,4).readUInt32BE(0);return s.slice(4,a+4).toString()}encrypt(t){let e=n.pseudoRandomBytes(16),i=Buffer.from(t),s=Buffer.from("4");s.writeUInt32BE(i.length,0);let a=Buffer.from(this.id),r=function(t){let e=32-t.length%32,i=Buffer.from(e.toString());return i.fill(e),Buffer.concat([t,i])}(Buffer.concat([e,s,i,a])),c=n.createCipheriv("aes-256-cbc",this.key,this.iv);return c.setAutoPadding(!1),Buffer.concat([c.update(r),c.final()]).toString("base64")}}function d(t){var e={};if("object"==typeof t)for(var i in t)if(t[i]instanceof Array&&0!==t[i].length)if(1===t[i].length){var s=t[i][0];e[i]="object"==typeof s?d(s):(s||"").trim()}else e[i]=[],t[i].forEach((function(t){e[i].push(d(t))}));return e}async function m(t){return new Promise(((e,i)=>{c.parseString(t,{trim:!0},(function(t,s){if(t)i(t);else{let t=d(s.xml);e(t)}}))}))}class g{constructor(t,e,i){this.appID=t,this.appSecret=e,this.util=i}checkAccess(t,e,i,s){let a=n.createHash("sha1"),r=[t,e,i].sort();return a.update(r.join("")),a.digest("hex")!==s}async decryptMessage(t,e="",i="",s=""){if("aes"!==e)return t;if(""===i)return this.util.logger.error("token 为空"),null;if(""===s)return this.util.logger.error("encodingAESKey 为空"),null;try{let e=new h(i,s,this.appID).decrypt(t.Encrypt);return await m(e)}catch(t){return this.util.logger.error(`解密失败：${JSON.stringify(t)}`),null}}}class T{buildMessage(t){return`<xml>\n                    <ToUserName><![CDATA[${t.ToUserName}]]></ToUserName>\n                    <FromUserName><![CDATA[${t.FromUserName}]]></FromUserName>\n                    <CreateTime>${t.CreateTime}</CreateTime>\n                    <MsgType><![CDATA[${t.MsgType}]]></MsgType>\n                    ${this.buildMessageContent(t)}\n                </xml>`}buildMessageContent(t){switch(t.MsgType){case"text":return`<Content><![CDATA[${t.Content}]]></Content>`;case"image":return`<Image>\n                            <MediaId><![CDATA[${t.Image.MediaId}]]></MediaId>\n                        </Image>`;case"voice":return`<Voice>\n                            <MediaId><![CDATA[${t.Voice.MediaId}]]></MediaId>\n                        </Voice>`;case"video":return`<Video>\n                            <MediaId><![CDATA[${t.Video.MediaId}]]></MediaId>\n                            ${"Title"in t.Video?`<Title><![CDATA[${t.Video.Title}]]></Title>`:""}\n                            ${"Description"in t.Video?`<Description><![CDATA[${t.Video.Description}]]></Description>`:""}\n                        </Video>`;case"music":return`<Music>\n                            <ThumbMediaId><![CDATA[${t.Music.ThumbMediaId}]]></ThumbMediaId>\n                            ${"Title"in t.Music?`<Title><![CDATA[${t.Music.Title}]]></Title>`:""}\n                            ${"Description"in t.Music?`<Description><![CDATA[${t.Music.Description}]]></Description>`:""}\n                            ${"MusicUrl"in t.Music?`<MusicUrl><![CDATA[${t.Music.MusicUrl}]]></MusicUrl>`:""}\n                            ${"HQMusicUrl"in t.Music?`<HQMusicUrl><![CDATA[${t.Music.HQMusicUrl}]]></HQMusicUrl>`:""}\n                        </Music>`;case"news":return`<ArticleCount>${t.Articles.length}</ArticleCount>\n                        <Articles>\n                            ${t.Articles.map((t=>`<item>\n                                                <Title><![CDATA[${t.Title}]]></Title>\n                                                <Description><![CDATA[${t.Description}]]></Description>\n                                                <PicUrl><![CDATA[${t.PicUrl}]]></PicUrl>\n                                                <Url><![CDATA[${t.Url}]]></Url>\n                                            </item>`)).join("")}\n                        </Articles>`}}}class w{constructor(t,e,i){this.appID=t,this.appSecret=e,this.util=i}async setIndustry(t,e){return this.util.request("https://api.weixin.qq.com/cgi-bin/template/api_set_industry",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{industry_id1:t,industry_id2:e}})}async getIndustry(){return this.util.request("https://api.weixin.qq.com/cgi-bin/template/get_industry",{method:"GET",params:{access_token:await this.util.accessToken(this.appID)}})}async add(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/template/api_add_template",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{template_id_short:t}})}async getTemplates(){return this.util.request("https://api.weixin.qq.com/cgi-bin/template/get_all_private_template",{method:"GET",params:{access_token:await this.util.accessToken(this.appID)}})}async del(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/template/del_private_template",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{template_id:t}})}async send(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/message/template/send",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:t})}}class q{constructor(t,e,i){this.appID=t,this.appSecret=e,this.util=i}async add(t){return this.util.request("https://api.weixin.qq.com/wxaapi/newtmpl/addtemplate",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:t})}async delete(t){return this.util.request("https://api.weixin.qq.com/wxaapi/newtmpl/deltemplate",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:{priTmplId:t}})}async getCategory(){return this.util.request("https://api.weixin.qq.com/wxaapi/newtmpl/getcategory",{method:"GET",params:{access_token:await this.util.accessToken(this.appID)}})}async getKeywords(t){return this.util.request("https://api.weixin.qq.com/wxaapi/newtmpl/getpubtemplatekeywords",{method:"GET",params:{access_token:await this.util.accessToken(this.appID),tid:t}})}async getPubTemplates(t,e,i){return this.util.request("https://api.weixin.qq.com/wxaapi/newtmpl/getpubtemplatetitles",{method:"GET",params:{access_token:await this.util.accessToken(this.appID),ids:t,start:e,limit:i}})}async getTemplates(){return this.util.request("https://api.weixin.qq.com/wxaapi/newtmpl/gettemplate",{method:"GET",params:{access_token:await this.util.accessToken(this.appID)}})}async send(t){return this.util.request("https://api.weixin.qq.com/cgi-bin/message/subscribe/bizsend",{method:"POST",params:{access_token:await this.util.accessToken(this.appID)},data:t})}}module.exports=class{constructor(t,e,i=null){this.appID=t,this.appSecret=e,this.util=new p,null!==i&&this.util.setAccessToken(i.getAccessToken),this.base=new u(this.appID,this.appSecret,this.util),this.openApi=new o(this.appID,this.appSecret,this.util),this.menu=new l(this.appID,this.appSecret,this.util),this.receive=new g(this.appID,this.appSecret,this.util),this.reply=new T,this.template=new w(this.appID,this.appSecret,this.util),this.subscribe=new q(this.appID,this.appSecret,this.util)}};
//# sourceMappingURL=index.js.map
